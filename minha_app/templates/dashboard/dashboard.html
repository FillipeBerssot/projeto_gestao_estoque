{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}

    {# ========================================================= #}
    {# Bloco de Cabeçalho da Página                              #}
    {# ========================================================= #}
    <div class="row align-items-center mb-4">
        <div class="col">
            <h2 class="page-title mb-0">Meu Dashboard</h2>
            <p class="page-subtitle mb-0">Bem-vindo(a), {{ current_user.username }}!</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('auth.logout') }}" class="btn btn-custom-secondary mb-0">Sair</a>
        </div>
    </div>

    {# ========================================================= #}
    {# Cards de Resumo                                           #}
    {# ========================================================= #}
    <div class="row">
        <div class="col-xl-6 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="numbers">
                            <p class="text-sm mb-0 text-uppercase font-weight-bold">Total Gasto ({{ nome_mes_selecionado }})</p>
                            <h5 class="font-weight-bolder">R$ {{ "%.2f"|format(total_gasto_mes) }}</h5>
                        </div>
                        <div class="icon icon-shape bg-gradient-primary shadow-primary rounded-circle d-flex align-items-center justify-content-center">
                            <img src="{{ url_for('static', filename='assets/img/icone-dinheiro.png') }}" style="width: 28px; height: 28px; filter: brightness(0) invert(1);">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-6 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="numbers">
                            <p class="text-sm mb-0 text-uppercase font-weight-bold">Compras no Período</p>
                            <h5 class="font-weight-bolder">{{ pagination.total }}</h5>
                        </div>
                        <div class="icon icon-shape bg-gradient-danger shadow-danger rounded-circle d-flex align-items-center justify-content-center">
                            <img src="{{ url_for('static', filename='assets/img/icone-carrinho.png') }}" style="width: 28px; height: 28px; filter: brightness(0) invert(1);">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ========================================================= #}
    {# Formulário de Filtro por Mês/Ano                          #}
    {# ========================================================= #}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header pb-0">
                    <h6 class="text-capitalize">Filtrar Período</h6>
                </div>
                <div class="card-body pt-2">
                    <form method="GET" action="{{ url_for('dashboard.view_dashboard') }}" class="row gx-3 gy-2 align-items-end">
                        <div class="col-md-4">
                            <label for="filter_month" class="form-label">Mês:</label>
                            <select name="filter_month" id="filter_month" class="form-select">
                                {% for month_num, month_name in month_options.items() %}
                                    <option value="{{ month_num }}" {% if month_num == selected_month %}selected{% endif %}>{{ month_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label for="filter_year" class="form-label">Ano:</label>
                            <input type="number" id="filter_year" name="filter_year" class="form-control" value="{{ selected_year }}">
                        </div>

                        <div class="col-md-2">
                            <label class="form-label d-none d-md-block">&nbsp;</label>
                            <button type="submit" class="btn bg-gradient-primary text-white w-100 mb-0">Filtrar</button>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label d-none d-md-block">&nbsp;</label>
                            <a href="{{ url_for('dashboard.view_dashboard') }}" class="btn bg-gradient-primary text-white w-100 mb-0">Limpar</a>
                        </div>
                        
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# ========================================================= #}
    {# Seção de Gráficos                                         #}
    {# ========================================================= #}
    <div class="row mt-4">
        <div class="col-lg-7 mb-lg-0 mb-4">
            <div class="card z-index-2">
                <div class="card-header pb-0 pt-3 bg-transparent">
                    <h6 class="text-capitalize">Evolução de Gastos (Últimos 6 Meses)</h6>
                </div>
                <div class="card-body p-3">
                    <div class="chart">
                        <canvas id="meuGraficoDeGastos" class="chart-canvas" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header pb-0 p-3">
                    <h6 class="mb-0">Gastos por Categoria (Futuro)</h6>
                </div>
                <div class="card-body p-3 d-flex align-items-center justify-content-center">
                    <p class="text-muted">Implementaremos em breve!</p>
                </div>
            </div>
        </div>
    </div>

    {# ========================================================= #}
    {# Bloco da Tabela de Compras e Lista de Categorias          #}
    {# ========================================================= #}
    <div class="row mt-4">
        
        {# Coluna da Esquerda: Tabela de Compras do Mês #}
        <div class="col-lg-7 mb-lg-0 mb-4">
            <div class="card">
                <div class="card-header pb-0">
                    <h6>Compras em {{ nome_mes_selecionado }}</h6>
                </div>
                <div class="card-body px-0 pt-0 pb-2">
                    {% if compras_mes_atual %}
                        <div class="table-responsive p-0">
                            <table class="table align-items-center mb-0">
                                <thead>
                                    <tr>
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Produto</th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Quantidade</th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Unidade</th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Valor</th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Data</th>
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for compra in compras_mes_atual %}
                                        <tr>
                                            <td>
                                                <div class="d-flex px-3 py-1">
                                                    <h6 class="mb-0 text-sm">{{ compra.product_name }}</h6>
                                                </div>
                                            </td>

                                            <td class="align-middle text-center text-sm">
                                                <span class="text-secondary text-xs font-weight-bold">{{ compra.quantity }}</span>
                                            </td>

                                            <td class="align-middle text-center text-sm">
                                                <span class="text-secondary text-xs font-weight-bold">{{ compra.unit }}</span>
                                            </td>

                                            <td class="align-middle text-center">
                                                <span class="text-success text-xs font-weight-bold">R$ {{ "%.2f"|format(compra.value) }}</span>
                                            </td>

                                            <td class="align-middle text-center text-sm">
                                                <span class="text-secondary text-xs font-weight-bold">{{ compra.purchase_date.strftime('%d/%m/%y') }}</span>
                                            </td>

                                            <td class="align-middle">
                                                <a href="#" 
                                                class="text-secondary view-details-btn" 
                                                data-purchase-id="{{ compra.id }}" 
                                                data-edit-url="{{ url_for('purchases.edit_purchase', purchase_id=compra.id) }}"
                                                data-bs-toggle="tooltip"
                                                data-bs-placement="top" 
                                                title="Ver Detalhes">
                                                    <img src="{{ url_for('static', filename='assets/img/icone-ver.png') }}" style="width: 22px; height: 22px;">
                                                </a>
                                                
                                                <a href="{{ url_for('purchases.edit_purchase', purchase_id=compra.id) }}" class="ms-3" data-bs-toggle="tooltip" data-bs-placement="top" title="Editar Compra">
                                                    <img src="{{ url_for('static', filename='assets/img/icone-editar.png') }}" style="width: 18px; height: 18px;">
                                                </a>
                                            </td>
                                            
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-center p-3 text-sm">Nenhuma compra registrada para este período.</p>
                    {% endif %}
                </div>
                
                {# ========================================================= #}
                {# Paginação #}
                {# ========================================================= #}
                {% if pagination and pagination.pages > 1 %}
                <div class="card-footer pt-1 p-3 border-top d-flex justify-content-center">
                  <nav aria-label="Paginação">
                    <ul class="pagination pagination-primary mb-0">
                      {# Link para Página Anterior #}
                      <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                          {% set prev_args = request.args.to_dict() %}
                          {% set _ = prev_args.update({'page': pagination.prev_num}) %}
                          <a class="page-link" href="{{ url_for('dashboard.view_dashboard', **prev_args) if pagination.has_prev else '#' }}">
                              &laquo;
                          </a>
                      </li>
                  
                      {# Links para os Números das Páginas #}
                      {% for p_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
                          {% if p_num %}
                              {% set page_args = request.args.to_dict() %}
                              {% set _ = page_args.update({'page': p_num}) %}
                              <li class="page-item {% if pagination.page == p_num %}active{% endif %}">
                                  <a class="page-link" href="{{ url_for('dashboard.view_dashboard', **page_args) }}">
                                      {{ p_num }}
                                  </a>
                              </li>
                          {% else %}
                              <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
                          {% endif %}
                      {% endfor %}
                  
                      {# Link para Próxima Página #}
                      <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                          {% set next_args = request.args.to_dict() %}
                          {% set _ = next_args.update({'page': pagination.next_num}) %}
                          <a class="page-link" href="{{ url_for('dashboard.view_dashboard', **next_args) if pagination.has_next else '#' }}">
                              &raquo;
                          </a>
                      </li>
                  </ul>
                  </nav>
              </div>
                {% endif %}
            </div>
        </div>

        {# Coluna da Direita: Lista de Categorias (Futuro) #}
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header pb-0">
                    <h6 class="mb-0">Categorias (Futuro)</h6>
                </div>
                <div class="card-body p-3">
                   <p class="text-muted text-sm">Implementaremos em breve!</p>
                </div>
            </div>
        </div>
    </div>

    {# ========================================================= #}
    {# Modal Para Visualizar Detalhes da Compra                  #}
    {# ========================================================= #}

    <div class="modal fade" id="purchaseDetailsModal" tabindex="-1" aria-labelledby="purchaseDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="purchaseDetailsModalLabel">Detalhes da Compra</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <ul class="list-group list-group-flush">
                <li class="list-group-item"><strong>Produto:</strong> <span id="modal-product-name"></span></li>

                <li class="list-group-item"><strong>Data:</strong> <span id="modal-purchase-date"></span></li>

                <li class="list-group-item"><strong>Valor:</strong> <span id="modal-value"></span></li>

                <li class="list-group-item"><strong>Quantidade:</strong> <span id="modal-quantity"></span></li>

                <li class="list-group-item"><strong>Unidade:</strong> <span id="modal-unity"></span></li>

                <li class="list-group-item">
                    <strong>Marca:</strong> 
                    <p id="modal-brand" class="text-sm text-secondary mt-1 mb-0" style="word-wrap: break-word;"></p>

                <li class="list-group-item">
                    <strong>Local:</strong> 
                    <p id="modal-location" class="text-sm text-secondary mt-1 mb-0" style="word-wrap: break-word;"></p>

                <li class="list-group-item">
                    <strong>Observações:</strong>
                    <p id="modal-notes" class="text-sm text-secondary mt-1 mb-0" style="word-wrap: break-word;"></p>
                </li>
            </ul>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary mb-0" data-bs-dismiss="modal">Fechar</button>
            <a href="#" id="modal-edit-button" class="btn bg-gradient-primary text-white mb-0">Editar</a>
        </div>
        </div>
    </div>
    </div>

{% endblock %}


{% block scripts %}
    {# ========================================================= #}
    {# Script do seu Gráfico de Barras original                  #}
    {# ========================================================= #}
    <script>
        const ctx = document.getElementById('meuGraficoDeGastos').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ grafico_labels|tojson }},
                datasets: [{
                    label: 'Total Gasto (R$)',
                    data: {{ grafico_data|tojson }},
                    backgroundColor: 'rgba(94, 114, 228, 0.8)',
                    borderColor: 'rgba(94, 114, 228, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                    borderSkipped: false,
                    maxBarThickness: 80
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        display: false,
                    } 
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: { drawBorder: false, display: true, drawOnChartArea: true, drawTicks: false, color: 'rgba(0, 0, 0, .08)' },
                        ticks: { 
                            display: true, padding: 10, color: '#6c757d',
                            callback: function(value) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value); }
                        } 
                    },
                    x: { 
                        grid: { drawBorder: false, display: false, drawOnChartArea: false, drawTicks: false },
                        ticks: { display: true, color: '#6c757d', padding: 20 } 
                    },
                },
            }
        });
    </script>

    <script>
        // Pega o nosso "molde" de modal
        var detailsModal = new bootstrap.Modal(document.getElementById('purchaseDetailsModal'));

        // Adiciona um "ouvinte" para todos os botões/links com a classe 'view-details-btn'
        document.querySelectorAll('.view-details-btn').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault(); // Impede que o link '#' recarregue a página
                
                const purchaseId = this.dataset.purchaseId; // Pega o ID da compra do botão que foi clicado
                const editUrl = this.dataset.editUrl; // Pega a URL de edição do botão

                // Faz a requisição "silenciosa" para a nossa nova rota no Flask
                fetch(`/purchases/purchase/details/${purchaseId}`)
                    .then(response => response.json())
                    .then(data => {
                        // Quando os dados chegarem, preenchemos o nosso modal
                        document.getElementById('modal-product-name').textContent = data.product_name;
                        document.getElementById('modal-purchase-date').textContent = data.purchase_date;
                        document.getElementById('modal-value').textContent = data.value;
                        document.getElementById('modal-quantity').textContent = data.quantity;
                        document.getElementById('modal-unity').textContent = data.unity;
                        document.getElementById('modal-brand').textContent = data.brand;
                        document.getElementById('modal-location').textContent = data.location;
                        document.getElementById('modal-notes').textContent = data.notes;
                        
                        // Atualiza o link do botão "Editar" do modal
                        document.getElementById('modal-edit-button').href = editUrl;

                        // Mostra o modal
                        detailsModal.show();
                    });
            });
        });
    </script>

{% endblock %}