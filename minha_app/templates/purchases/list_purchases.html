{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
    {# ========================================================= #}
    {# Bloco de Cabeçalho da Página                              #}
    {# ========================================================= #}
    <div class="row align-items-center mb-4">
    <div class="col">
        <h2 class="page-title mb-0 text-white">Minhas Compras</h2>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('auth.logout') }}" class="btn btn-dark mb-0">Sair</a>
    </div>
    </div>

    {# Formulário de Filtro/Busca #}
    <form method="GET" action="{{ url_for('purchases.list_purchases')}}" style="margin-bottom: 20px; border: 1px solid #ccc; padding: 10px;">
        <div style="display: inline-block; margin-right: 15px;">
            <label for="search_product_name">Buscar por Nome do Produto:</label><br>
            <input type="text" id="search_product_name" name="search_product_name" value="{{ search_term or '' }}">
        </div>

        {# NOVO CAMPO DE FILTRO POR DATA ESPECÍFICA #}
        <div style="display: inline-block; margin-right: 15px;">
            <label for="filter_date">Filtrar por Data Específica:</label><br>
            <input type="date" id="filter_date" name="filter_date" value="{{ filter_date or ''}}">
        </div>

        <button type="submit" style="vertical-align: bottom;">Buscar / Filtrar</button>
        {% if search_term or filter_date_str %}
            <a href="{{ url_for('purchases.list_purchases') }}" style="margin-left: 10px; vertical-align: bottom;">Limpar Filtros</a>
        {% endif %}
    </form>

    <div style="margin-bottom: 20px;">
        <a href="{{ url_for('purchases.export_csv', **request.args) }}">Exportar Resultados para CSV</a>
    </div>

    {% if purchases %}
    <table border="1" style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th>Data</th>
                <th>Produto</th>
                <th>Marca</th>
                <th>Quantidade</th>
                <th>Unidade</th>
                <th>Valor (R$)</th>
                <th>Local</th>
                <th>Observações</th>
                <th>Ações</th>
            </tr>
        </thead>

        <tbody>
            {% for purchase in purchases %}
            <tr>
                <td>{{ purchase.purchase_date.strftime('%d/%m/%Y') if purchase.purchase_date else 'N/A' }}</td>
                <td>{{ purchase.product_name }}</td>
                <td>{{ purchase.brand if purchase.brand else '-' }}</td>
                <td>{{ purchase.quantity }}</td>
                <td>{{ purchase.unit }}</td>
                <td>{{ "%.2f"|format (purchase.value) }}</td>
                <td>{{ purchase.location if purchase.location else '-' }}</td>
                <td>{{ purchase.notes if purchase.notes else '-' }}</td>
                <td>
                    <form method="GET" 
                        action="{{ url_for('purchases.edit_purchase', purchase_id=purchase.id) }}"
                        style="display: inline; margin-right: 5px; vertical-align: middle;">
                        <input type="submit" value="Editar"
                            style="background-color: #28a745;
                                color: white; 
                                padding: 2px 5px; 
                                text-decoration: none;
                                border-radius: 3px; 
                                display: inline-block;
                                border: none;
                                cursor: pointer;
                                vertical-align: middle;
                                margin-right: 5px;">
                    </form>

                    <form method="POST"
                        action="{{ url_for('purchases.delete_purchase', purchase_id=purchase.id) }}" 
                        style="display: inline; vertical-align: middle;" 
                        onsubmit="return confirm('Tem certeza que deseja excluir esta compra? Ela será removida permanentemente.');">
                        {{ form.hidden_tag() if form and form.hidden_tag }}
                        <input type="submit" value="Excluir" 
                                style="background-color: #dc3545; 
                                    color: white; 
                                    border: none; 
                                    padding: 2px 5px; 
                                    text-decoration: none;
                                    display: inline-block;
                                    cursor: pointer;
                                    vertical-align: middle;
                                    border-radius: 3px;">
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

{% else %}
    {% if search_term or filter_date_str %}
        <p>Nenhuma compra encontrada com os filtros atuais que você aplicou.</p>
        <p>Você pode tentar <a href="{{ url_for('purchases.list_purchases') }}">limpar os filtros</a> para ver todas as compras, ou <a href="{{ url_for('purchases.add_purchase') }}">adicionar uma nova compra</a>.</p>
    {% else %}
        <p>Você ainda não registrou nenhuma compra. Que tal <a href="{{ url_for('purchases.add_purchase') }}">adicionar sua primeira compra agora</a>?</p>    
    {% endif %}
{% endif %}

    {# Paginação #}
    {% if pagination %}
    <nav aria-label="Paginação das Compras">
        <ul class="pagination" style="list-style: none; display: flex; padding: 0;">

            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}" style="margin-right: 5px;">
                <a class="page-link" href="{{ url_for('purchases.list_purchases', page=pagination.prev_num, search_product_name=search_term if search_term else None, filter_date=filter_date_str if filter_date_str else None) if pagination.has_prev else '#_prev' }}">
                    &laquo; Anterior
                </a>
            </li>

            {# Links para os Números das Páginas #}
            {% for p_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if p_num %}
                    {% if pagination.page == p_num %}
                    <li class="page-item active" style="margin-right: 5px;">
                        <a class="page-link" href="{{ url_for('purchases.list_purchases', page=p_num, search_product_name=search_term if search_term else None, filter_date=filter_date_str if filter_date_str else None) }}">{{ p_num }}</a>
                    </li>
                {% else %} {# Adicionando o else para as páginas não ativas #}
                    <li class="page-item" style="margin-right: 5px;">
                        <a class="page-link" href="{{ url_for('purchases.list_purchases', page=p_num, search_product_name=search_term if search_term else None, filter_date=filter_date_str if filter_date_str else None) }}">{{ p_num }}</a>
                    </li>
                    {% endif %}
            
                {% else %}
                    <li class="page-item disabled" style="margin-right: 5px;"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            {# Link para a Próxima Página #}
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}" style="margin-left: 5px;">
                <a class="page-link" href="{{ url_for('purchases.list_purchases', page=pagination.next_num, search_product_name=search_term if search_term else None, filter_date=filter_date_str if filter_date_str else None) if pagination.has_next else '#_next' }}">
                    Próxima &raquo;
                </a>
            </li>
        </ul>
    </nav>

    <p style="font-size: 0.9em;">
        Mostrando página {{ pagination.page }} de {{ pagination.pages }}. Total de {{ pagination.total }} compras.
    </p>
    {% endif %}

    <br>

    <p><a href="{{ url_for('purchases.add_purchase') }}">Adicionar Nova Compra</a></p>
{% endblock %}